#!/usr/bin/env pwsh
<#
.SYNOPSIS
    Enhanced build script with string encryption support

.DESCRIPTION
    Builds ECoopSystem with encrypted string support for production releases.
    Encrypts sensitive URLs and configuration data before compilation.

.EXAMPLE
    .\build-secure.ps1 -IFrameUrl "https://client.com" -ApiUrl "https://api.com" -Platform windows
#>

param(
    [string]$IFrameUrl = "https://e-coop-client-development.up.railway.app/",
    [string]$ApiUrl = "https://e-coop-server-development.up.railway.app/",
    [string]$AppName = "ECoopSystem",
    [string]$AppLogo = "Assets/Images/logo.png",
    [ValidateSet("windows", "linux", "linux-deb", "linux-arm", "mac-intel", "mac-arm")]
    [string]$Platform = "windows",
    [ValidateSet("Debug", "Release")]
    [string]$Configuration = "Release",
    [switch]$SelfContained = $true,
    [switch]$SkipObfuscation
)

# Runtime identifiers
$runtimeIds = @{
    "windows" = "win-x64"
    "linux" = "linux-x64"
    "linux-deb" = "linux-x64"
    "linux-arm" = "linux-arm64"
    "mac-intel" = "osx-x64"
    "mac-arm" = "osx-arm64"
}

$rid = $runtimeIds[$Platform]

Write-Host "=========================================" -ForegroundColor Cyan
Write-Host " Building $AppName (SECURE)" -ForegroundColor Cyan
Write-Host "=========================================" -ForegroundColor Cyan
Write-Host "IFrame URL: $IFrameUrl" -ForegroundColor White
Write-Host "API URL:    $ApiUrl" -ForegroundColor White
Write-Host "Platform:   $Platform ($rid)" -ForegroundColor White
Write-Host "Config:     $Configuration" -ForegroundColor White
Write-Host ""

# Function to encrypt strings using C# encryption logic
function Encrypt-String {
    param([string]$plainText)
    
    $data1 = "ECoopSystem.SecureKey.2026.LandsHorizon.v1"
    $data2 = "ECoopSystem.IV.2026.SecureInit"
    
    $sha256 = [System.Security.Cryptography.SHA256]::Create()
    $key = $sha256.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($data1))
    $hashIV = $sha256.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($data2))
    $iv = $hashIV[0..15]
    
    $aes = [System.Security.Cryptography.Aes]::Create()
    $aes.Key = $key
    $aes.IV = $iv
    $aes.Mode = [System.Security.Cryptography.CipherMode]::CBC
    $aes.Padding = [System.Security.Cryptography.PaddingMode]::PKCS7
    
    $encryptor = $aes.CreateEncryptor($aes.Key, $aes.IV)
    $plainBytes = [System.Text.Encoding]::UTF8.GetBytes($plainText)
    $encryptedBytes = $encryptor.TransformFinalBlock($plainBytes, 0, $plainBytes.Length)
    
    return [Convert]::ToBase64String($encryptedBytes)
}

# Encrypt sensitive data
Write-Host "Encrypting sensitive strings..." -ForegroundColor Yellow
$encryptedIFrameUrl = Encrypt-String -plainText $IFrameUrl
$encryptedApiUrl = Encrypt-String -plainText $ApiUrl
$encryptedAppName = Encrypt-String -plainText $AppName

Write-Host "? Strings encrypted" -ForegroundColor Green
Write-Host ""

# Generate SecureBuildConfiguration.cs
Write-Host "Generating SecureBuildConfiguration.cs..." -ForegroundColor Yellow
$configTemplate = @"
// <auto-generated>
//     This file is auto-generated during secure build.
//     All sensitive strings are encrypted.
// </auto-generated>

using System;
using ECoopSystem.Utilities;

namespace ECoopSystem.Build;

/// <summary>
/// Encrypted build-time configuration strings.
/// All URLs and sensitive data are encrypted to prevent reverse engineering.
/// </summary>
public static class SecureBuildConfiguration
{
    // Encrypted versions of URLs - only decrypted at runtime
    private const string EncryptedIFrameUrl = "$encryptedIFrameUrl";
    private const string EncryptedApiUrl = "$encryptedApiUrl";
    private const string EncryptedAppName = "$encryptedAppName";
    
    /// <summary>
    /// WebView/IFrame URL (decrypted at runtime)
    /// </summary>
    public static string IFrameUrl => StringEncryption.Decrypt(EncryptedIFrameUrl);
    
    /// <summary>
    /// API Server URL (decrypted at runtime)
    /// </summary>
    public static string ApiUrl => StringEncryption.Decrypt(EncryptedApiUrl);
    
    /// <summary>
    /// Application Name (decrypted at runtime)
    /// </summary>
    public static string AppName => StringEncryption.Decrypt(EncryptedAppName);
    
    /// <summary>
    /// Application Logo Path (not sensitive, kept as-is)
    /// </summary>
    public const string AppLogo = "$AppLogo";
}
"@

Set-Content -Path "Build\SecureBuildConfiguration.cs" -Value $configTemplate
Write-Host "? Configuration generated" -ForegroundColor Green
Write-Host ""

# Build the application
Write-Host "Building application..." -ForegroundColor Yellow
$publishArgs = @(
    "publish"
    "-c", $Configuration
    "-r", $rid
    "-p:IFrameUrl=$IFrameUrl"
    "-p:ApiUrl=$ApiUrl"
    "-p:AppName=$AppName"
)

if ($SelfContained) {
    $publishArgs += "--self-contained"
    $publishArgs += "-p:PublishSingleFile=true"
    $publishArgs += "-p:IncludeNativeLibrariesForSelfExtract=true"
}

& dotnet @publishArgs

if ($LASTEXITCODE -ne 0) {
    Write-Host "? Build failed" -ForegroundColor Red
    exit $LASTEXITCODE
}

Write-Host ""
Write-Host "? Build completed" -ForegroundColor Green
Write-Host "Output: bin\$Configuration\net9.0\$rid\publish\" -ForegroundColor Cyan

# Optional: Run obfuscation if ConfuserEx is available and not skipped
if (-not $SkipObfuscation -and $Configuration -eq "Release") {
    $confuserExe = ".\Tools\ConfuserEx\Confuser.CLI.exe"
    
    if (Test-Path $confuserExe) {
        Write-Host ""
        Write-Host "Running code obfuscation..." -ForegroundColor Yellow
        
        # Update confuser.crproj with correct path
        $confuserConfig = @"
<project baseDir="." outputDir=".\Confused" xmlns="http://confuser.codeplex.com">
  <rule pattern="true" inherit="false">
    <protection id="anti tamper" />
    <protection id="ctrl flow" />
    <protection id="ref proxy" />
    <protection id="rename">
      <argument name="mode" value="decodable" />
    </protection>
    <protection id="constants">
      <argument name="mode" value="dynamic" />
    </protection>
    <protection id="resources" />
    <protection id="anti debug" />
    <protection id="anti dump" />
  </rule>
  <module path="bin\$Configuration\net9.0\$rid\publish\ECoopSystem.dll" />
</project>
"@
        Set-Content -Path "confuser-temp.crproj" -Value $confuserConfig
        
        & $confuserExe -n "confuser-temp.crproj"
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "? Obfuscation completed" -ForegroundColor Green
            Write-Host "Obfuscated output: .\Confused\" -ForegroundColor Cyan
        } else {
            Write-Host "? Obfuscation failed or skipped" -ForegroundColor Yellow
        }
        
        Remove-Item "confuser-temp.crproj" -ErrorAction SilentlyContinue
    } else {
        Write-Host ""
        Write-Host "? ConfuserEx not found at $confuserExe" -ForegroundColor Yellow
        Write-Host "Download from: https://github.com/mkaring/ConfuserEx/releases" -ForegroundColor Cyan
        Write-Host "To skip obfuscation check, use -SkipObfuscation flag" -ForegroundColor Cyan
    }
}

Write-Host ""
Write-Host "=========================================" -ForegroundColor Cyan
Write-Host " Build Complete!" -ForegroundColor Green
Write-Host "=========================================" -ForegroundColor Cyan
