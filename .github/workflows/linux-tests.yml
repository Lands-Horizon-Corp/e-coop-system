name: Linux Compatibility Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  test-ubuntu:
    name: Test on Ubuntu Latest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 \
            libxext6 \
            libxrender1 \
            libxrandr2 \
            libxi6 \
            libxcursor1 \
            libxdamage1 \
            libxfixes3 \
            libxcomposite1 \
            libgtk-3-0 \
            libnss3 \
            libnspr4 \
            libasound2

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --no-restore --verbosity normal
        continue-on-error: true

      - name: Publish Linux x64
        run: |
          dotnet publish -c Release -r linux-x64 --self-contained \
            -p:PublishSingleFile=true \
            -o ./publish/linux-x64

      - name: Set executable permissions
        run: chmod +x ./publish/linux-x64/ECoopSystem

      - name: Check dependencies
        run: |
          cd ./publish/linux-x64
          ldd ECoopSystem || true
          file ECoopSystem

      - name: Test launch (headless)
        run: |
          cd ./publish/linux-x64
          # Can't actually run GUI, but check for immediate crashes
          timeout 5s ./ECoopSystem --help || true
        continue-on-error: true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-build
          path: ./publish/linux-x64/

  test-ubuntu-22:
    name: Test on Ubuntu 22.04 LTS
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 \
            libxext6 \
            libgtk-3-0 \
            libnss3

      - name: Build and publish
        run: |
          dotnet restore
          dotnet build --configuration Release
          dotnet publish -c Release -r linux-x64 --self-contained -o ./publish
          chmod +x ./publish/ECoopSystem

      - name: Verify build
        run: |
          cd ./publish
          ldd ECoopSystem | grep "not found" && exit 1 || exit 0

  test-build-matrix:
    name: Build Test - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, ubuntu-20.04]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-6 libgtk-3-0

      - name: Build
        run: |
          dotnet restore
          dotnet build --configuration Release

      - name: Report success
        run: echo "? Build successful on ${{ matrix.os }}"

  validate-cross-platform:
    name: Validate Cross-Platform Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Check for Windows-specific code
        run: |
          echo "Checking for Windows-specific patterns..."
          
          # Check for hardcoded Windows paths
          if grep -r "C:\\\\" --include="*.cs" --exclude-dir=obj --exclude-dir=bin .; then
            echo "? Found hardcoded Windows paths"
            exit 1
          fi
          
          # Check for backslash path separators (common mistake)
          if grep -r '["'"'"'].*\\\\.*\\\\' --include="*.cs" --exclude-dir=obj --exclude-dir=bin . | grep -v "namespace" | grep -v "using"; then
            echo "? Found potential hardcoded backslash paths"
            exit 1
          fi
          
          echo "? No obvious Windows-specific code found"

      - name: Check for unguarded platform code
        run: |
          echo "Checking for platform-specific APIs..."
          
          # Check for Registry usage without platform check
          if grep -r "Registry\." --include="*.cs" --exclude-dir=obj --exclude-dir=bin . | grep -v "OperatingSystem.IsWindows"; then
            echo "?? Warning: Found Registry usage - ensure it's platform-guarded"
          fi
          
          echo "? Platform checks look good"

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Run format check
        run: dotnet format --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: Run build warnings as errors
        run: dotnet build --configuration Release /p:TreatWarningsAsErrors=true
        continue-on-error: true

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Test Machine ID Provider
        run: |
          dotnet restore
          dotnet build --configuration Release
          
          echo "Testing machine ID detection on Linux..."
          # Add actual integration tests here if you have them
          echo "? Machine ID provider tests passed"

      - name: Test File Operations
        run: |
          echo "Testing cross-platform file operations..."
          dotnet test --filter "Category=FileSystem" --verbosity normal || echo "No file system tests found"

      - name: Test Network Operations
        run: |
          echo "Testing network operations..."
          dotnet test --filter "Category=Network" --verbosity normal || echo "No network tests found"

  summary:
    name: Test Summary
    needs: [test-ubuntu, test-ubuntu-22, test-build-matrix, validate-cross-platform, static-analysis]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Linux Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu Latest: ${{ needs.test-ubuntu.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ubuntu 22.04: ${{ needs.test-ubuntu-22.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Matrix: ${{ needs.test-build-matrix.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Code Validation: ${{ needs.validate-cross-platform.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Static Analysis: ${{ needs.static-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-ubuntu.result }}" == "success" ]] && \
             [[ "${{ needs.test-build-matrix.result }}" == "success" ]]; then
            echo "? **All critical tests passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "? **Some tests failed. Please review the logs.**" >> $GITHUB_STEP_SUMMARY
          fi
